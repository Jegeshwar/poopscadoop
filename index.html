<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen Chaos - Cooking Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            overflow: hidden;
        }

        .screen {
            width: 100vw;
            height: 100vh;
            display: none;
            position: absolute;
            top: 0;
            left: 0;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .welcome-screen {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
        }

        .welcome-screen h1 {
            font-size: 4rem;
            margin-bottom: 2rem;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .menu-button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 1rem 2rem;
            margin: 1rem;
            font-size: 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .menu-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .character-select {
            display: flex;
            gap: 2rem;
            margin: 2rem 0;
        }

        .character {
            width: 150px;
            height: 150px;
            border: 4px solid transparent;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .character:hover {
            transform: scale(1.1);
            border-color: #ffeb3b;
        }

        .character.selected {
            border-color: #4caf50;
            transform: scale(1.15);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
        }

        .character svg, .character img {
            width: 80%;
            height: 80%;
        }

        .game-screen {
            background: linear-gradient(45deg, #ffeaa7, #fab1a0);
            position: relative;
        }

        .kitchen {
            width: 100%;
            height: 100%;
            position: relative;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255,255,255,0.1) 0%, transparent 50%),
                linear-gradient(135deg, #ddd 0%, #f0f0f0 100%);
            background-size: 100px 100px, cover;
        }

        .counter {
            position: absolute;
            background: linear-gradient(145deg, #8d6e63, #6d4c41);
            border: 3px solid #5d4037;
            border-radius: 10px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3), 0 5px 15px rgba(0,0,0,0.2);
        }

        .counter-top {
            width: 150px;
            height: 80px;
            top: 200px;
            left: 100px;
        }

        .stove {
            width: 120px;
            height: 120px;
            top: 150px;
            left: 300px;
            background: linear-gradient(145deg, #424242, #212121);
            border-radius: 15px;
        }

        .stove::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 20px;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, #ff5722 0%, #d32f2f 70%);
            border-radius: 50%;
            animation: flame 1s infinite alternate;
        }

        @keyframes flame {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.1); opacity: 1; }
        }

        .sink {
            width: 100px;
            height: 80px;
            top: 180px;
            left: 500px;
            background: linear-gradient(145deg, #90a4ae, #607d8b);
        }

        .sink::before {
            content: '💧';
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            animation: drip 2s infinite;
        }

        @keyframes drip {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .ingredient {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: white;
            border: 2px solid #333;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .ingredient:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        .tomato { top: 320px; left: 120px; background: linear-gradient(145deg, #f44336, #c62828); }
        .onion { top: 320px; left: 180px; background: linear-gradient(145deg, #ffeb3b, #f57f17); }
        .mushroom { top: 320px; left: 240px; background: linear-gradient(145deg, #8d6e63, #5d4037); }
        .pot { top: 320px; left: 320px; background: linear-gradient(145deg, #9e9e9e, #424242); }
        .bowl { top: 320px; left: 380px; background: linear-gradient(145deg, #2196f3, #0d47a1); }

        .player {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            transition: all 0.3s;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 3px solid #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .player svg {
            width: 80%;
            height: 80%;
        }

        .ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        .ui > * {
            pointer-events: auto;
        }

        .timer {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(145deg, #f44336, #c62828);
            color: white;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-size: 2rem;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .score {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(145deg, #4caf50, #2e7d32);
            color: white;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .orders {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.95);
            padding: 1rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            min-width: 300px;
        }

        .order {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            margin: 0.5rem 0;
            background: linear-gradient(145deg, #fff3e0, #ffe0b2);
            border-radius: 10px;
            border: 2px solid #ff9800;
        }

        .order-timer {
            background: linear-gradient(145deg, #ff5722, #d32f2f);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 1rem;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        .tutorial-screen {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            text-align: center;
            padding: 2rem;
        }

        .tutorial-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .tutorial-item {
            background: rgba(255,255,255,0.1);
            margin: 1rem 0;
            padding: 1.5rem;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 3rem;
            border-radius: 20px;
            text-align: center;
            display: none;
        }

        .notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, #4caf50, #2e7d32);
            color: white;
            padding: 1rem 2rem;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1000;
        }

        .notification.show {
            opacity: 1;
        }

        .notification.error {
            background: linear-gradient(145deg, #f44336, #c62828);
        }

        .held-item {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 25px;
            height: 25px;
            border-radius: 5px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 2px solid #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div class="screen active" id="welcome-screen">
        <div class="welcome-screen">
            <h1>🍳 Kitchen Chaos 🍳</h1>
            <p style="font-size: 1.5rem; margin-bottom: 3rem;">Master the art of cooking!</p>
            <button class="menu-button" onclick="showModeSelect()">Start Game</button>
        </div>
    </div>

    <!-- Mode Selection Screen -->
    <div class="screen" id="mode-screen">
        <div class="welcome-screen">
            <h2 style="font-size: 3rem; margin-bottom: 2rem;">Select Game Mode</h2>
            <button class="menu-button" onclick="showPlayerSelect('single')">Single Player</button>
            <button class="menu-button" onclick="showPlayerSelect('multi')">Multiplayer</button>
            <button class="menu-button" onclick="showScreen('welcome-screen')">Back</button>
        </div>
    </div>

    <!-- Player Count Screen -->
    <div class="screen" id="player-screen">
        <div class="welcome-screen">
            <h2 style="font-size: 3rem; margin-bottom: 2rem;">How Many Players?</h2>
            <button class="menu-button" onclick="setPlayers(2)">2 Players</button>
            <button class="menu-button" onclick="setPlayers(3)">3 Players</button>
            <button class="menu-button" onclick="setPlayers(4)">4 Players</button>
            <button class="menu-button" onclick="showScreen('mode-screen')">Back</button>
        </div>
    </div>

    <!-- Character Selection Screen -->
    <div class="screen" id="character-screen">
        <div class="welcome-screen">
            <h2 style="font-size: 2.5rem; margin-bottom: 2rem;">Choose Your Character</h2>
            <div class="character-select">
                <div class="character" onclick="selectCharacter('cat')">
                    <svg viewBox="0 0 400 400" style="fill: #ff8c42;">
                        <ellipse cx="200" cy="280" rx="80" ry="100" fill="#ff8c42"/>
                        <ellipse cx="200" cy="150" rx="60" ry="50" fill="#ff8c42"/>
                        <polygon points="160,120 140,80 180,100" fill="#ff8c42"/>
                        <polygon points="240,120 260,80 220,100" fill="#ff8c42"/>
                        <circle cx="180" cy="140" r="15" fill="#4caf50"/>
                        <circle cx="220" cy="140" r="15" fill="#4caf50"/>
                        <circle cx="175" cy="145" r="8" fill="#333"/>
                        <circle cx="215" cy="145" r="8" fill="#333"/>
                        <ellipse cx="200" cy="160" rx="3" ry="2" fill="#333"/>
                        <path d="M190 170 Q200 180 210 170" stroke="#333" stroke-width="2" fill="none"/>
                        <ellipse cx="120" cy="300" rx="15" ry="20" fill="#ff8c42"/>
                        <ellipse cx="280" cy="300" rx="15" ry="20" fill="#ff8c42"/>
                        <ellipse cx="180" cy="380" rx="12" ry="15" fill="#ff8c42"/>
                        <ellipse cx="220" cy="380" rx="12" ry="15" fill="#ff8c42"/>
                        <path d="M120 280 Q100 200 80 150" stroke="#ff8c42" stroke-width="15" fill="none"/>
                    </svg>
                    <p style="margin-top: 10px; color: #333;">Cat</p>
                </div>
                <div class="character" onclick="selectCharacter('dog')">
                    <svg viewBox="0 0 400 400" style="fill: #ffb74d;">
                        <ellipse cx="200" cy="280" rx="70" ry="90" fill="#ffb74d"/>
                        <ellipse cx="200" cy="160" rx="50" ry="40" fill="#ffb74d"/>
                        <ellipse cx="150" cy="140" rx="25" ry="35" fill="#ffb74d"/>
                        <ellipse cx="250" cy="140" rx="25" ry="35" fill="#ffb74d"/>
                        <circle cx="185" cy="150" r="12" fill="#333"/>
                        <circle cx="215" cy="150" r="12" fill="#333"/>
                        <ellipse cx="200" cy="170" rx="8" ry="6" fill="#333"/>
                        <path d="M185 185 Q200 195 215 185" stroke="#333" stroke-width="3" fill="none"/>
                        <ellipse cx="160" cy="340" rx="15" ry="25" fill="#ffb74d"/>
                        <ellipse cx="240" cy="340" rx="15" ry="25" fill="#ffb74d"/>
                        <ellipse cx="175" cy="385" rx="12" ry="15" fill="#ffb74d"/>
                        <ellipse cx="225" cy="385" rx="12" ry="15" fill="#ffb74d"/>
                        <path d="M270 200 Q290 180 300 160 Q310 180 290 200" stroke="#ffb74d" stroke-width="12" fill="none"/>
                    </svg>
                    <p style="margin-top: 10px; color: #333;">Dog</p>
                </div>
                <div class="character" onclick="selectCharacter('human')">
                    <svg viewBox="0 0 400 400" style="stroke: #333; stroke-width: 8; fill: none;">
                        <circle cx="200" cy="100" r="40"/>
                        <path d="M160 60 L140 40 M240 60 L260 40"/>
                        <circle cx="185" cy="90" r="3" fill="#333"/>
                        <circle cx="215" cy="90" r="3" fill="#333"/>
                        <path d="M185 110 Q200 120 215 110"/>
                        <rect x="170" y="140" width="60" height="80" rx="10"/>
                        <rect x="175" y="220" width="50" height="60" rx="8"/>
                        <line x1="170" y1="160" x2="130" y2="200"/>
                        <line x1="230" y1="160" x2="270" y2="200"/>
                        <line x1="185" y1="280" x2="185" y2="350"/>
                        <line x1="215" y1="280" x2="215" y2="350"/>
                        <circle cx="185" cy="365" r="12" fill="#333"/>
                        <circle cx="215" cy="365" r="12" fill="#333"/>
                    </svg>
                    <p style="margin-top: 10px; color: #333;">Human</p>
                </div>
            </div>
            <button class="menu-button" onclick="showTutorial()" id="start-button" style="display: none;">Continue</button>
            <button class="menu-button" onclick="goBack()">Back</button>
        </div>
    </div>

    <!-- Tutorial Screen -->
    <div class="screen" id="tutorial-screen">
        <div class="tutorial-screen">
            <h2 style="font-size: 3rem; margin-bottom: 2rem;">Tutorial</h2>
            <div class="tutorial-content">
                <div class="tutorial-item">
                    <h3>🍅 Ingredients</h3>
                    <p>Tomato (🍅), Onion (🧅), Mushroom (🍄) - Click to pick up ingredients</p>
                </div>
                <div class="tutorial-item">
                    <h3>🔪 Chopping</h3>
                    <p>Click on the counter with an ingredient to chop it. Chopped ingredients become soup base!</p>
                </div>
                <div class="tutorial-item">
                    <h3>🍲 Cooking</h3>
                    <p>Put chopped ingredients in a pot, then place on the stove to cook</p>
                </div>
                <div class="tutorial-item">
                    <h3>🧽 Washing</h3>
                    <p>Click on dirty dishes at the sink to wash them</p>
                </div>
                <div class="tutorial-item">
                    <h3>⏱️ Orders</h3>
                    <p>Complete orders before time runs out! Each dish gives 73 XP, failed orders lose 70 XP</p>
                </div>
            </div>
            <button class="menu-button" onclick="startGame()">Start Cooking!</button>
            <button class="menu-button" onclick="showScreen('character-screen')">Back</button>
        </div>
    </div>

    <!-- Game Screen -->
    <div class="screen" id="game-screen">
        <div class="kitchen">
            <!-- Kitchen Equipment -->
            <div class="counter counter-top"></div>
            <div class="counter stove"></div>
            <div class="counter sink"></div>

            <!-- Ingredients -->
            <div class="ingredient tomato" data-type="tomato">🍅</div>
            <div class="ingredient onion" data-type="onion">🧅</div>
            <div class="ingredient mushroom" data-type="mushroom">🍄</div>
            <div class="ingredient pot" data-type="pot">🍲</div>
            <div class="ingredient bowl" data-type="bowl">🥣</div>

            <!-- Player -->
            <div class="player" id="player1" style="top: 400px; left: 200px;">
                <!-- Character will be inserted here -->
            </div>
        </div>

        <!-- UI Elements -->
        <div class="ui">
            <div class="timer">3:00</div>
            <div class="score">XP: 0</div>
            <div class="orders">
                <h3 style="margin-bottom: 1rem; color: #333;">Orders</h3>
                <div id="orders-list"></div>
            </div>
            <div class="controls">
                <strong>Controls:</strong><br>
                WASD - Move<br>
                Space - Pick up/Use<br>
                Click - Interact
            </div>
        </div>

        <div class="game-over" id="game-over">
            <h2>Game Over!</h2>
            <p id="final-score">Final Score: 0 XP</p>
            <button class="menu-button" onclick="restartGame()">Play Again</button>
            <button class="menu-button" onclick="showScreen('welcome-screen')">Main Menu</button>
        </div>

        <div class="notification" id="notification"></div>
    </div>

    <script>
        // Game State
        let gameState = {
            mode: 'single',
            playerCount: 1,
            selectedCharacter: null,
            score: 0,
            timeLeft: 180, // 3 minutes
            orders: [],
            players: [],
            heldItems: {},
            gameRunning: false,
            lastOrderTime: 0
        };

        // Game Data
        const soups = [
            { name: 'Tomato Soup', ingredient: 'tomato', emoji: '🍅', color: '#f44336' },
            { name: 'Onion Soup', ingredient: 'onion', emoji: '🧅', color: '#ffeb3b' },
            { name: 'Mushroom Soup', ingredient: 'mushroom', emoji: '🍄', color: '#8d6e63' }
        ];

        const characters = {
            cat: `<svg viewBox="0 0 400 400" style="fill: #ff8c42;">
                <ellipse cx="200" cy="280" rx="80" ry="100" fill="#ff8c42"/>
                <ellipse cx="200" cy="150" rx="60" ry="50" fill="#ff8c42"/>
                <polygon points="160,120 140,80 180,100" fill="#ff8c42"/>
                <polygon points="240,120 260,80 220,100" fill="#ff8c42"/>
                <circle cx="180" cy="140" r="15" fill="#4caf50"/>
                <circle cx="220" cy="140" r="15" fill="#4caf50"/>
                <circle cx="175" cy="145" r="8" fill="#333"/>
                <circle cx="215" cy="145" r="8" fill="#333"/>
                <ellipse cx="200" cy="160" rx="3" ry="2" fill="#333"/>
                <path d="M190 170 Q200 180 210 170" stroke="#333" stroke-width="2" fill="none"/>
            </svg>`,
            dog: `<svg viewBox="0 0 400 400" style="fill: #ffb74d;">
                <ellipse cx="200" cy="280" rx="70" ry="90" fill="#ffb74d"/>
                <ellipse cx="200" cy="160" rx="50" ry="40" fill="#ffb74d"/>
                <ellipse cx="150" cy="140" rx="25" ry="35" fill="#ffb74d"/>
                <ellipse cx="250" cy="140" rx="25" ry="35" fill="#ffb74d"/>
                <circle cx="185" cy="150" r="12" fill="#333"/>
                <circle cx="215" cy="150" r="12" fill="#333"/>
                <ellipse cx="200" cy="170" rx="8" ry="6" fill="#333"/>
                <path d="M185 185 Q200 195 215 185" stroke="#333" stroke-width="3" fill="none"/>
            </svg>`,
            human: `<svg viewBox="0 0 400 400" style="stroke: #333; stroke-width: 8; fill: none;">
                <circle cx="200" cy="100" r="40"/>
                <path d="M160 60 L140 40 M240 60 L260 40"/>
                <circle cx="185" cy="90" r="3" fill="#333"/>
                <circle cx="215" cy="90" r="3" fill="#333"/>
                <path d="M185 110 Q200 120 215 110"/>
                <rect x="170" y="140" width="60" height="80" rx="10"/>
                <rect x="175" y="220" width="50" height="60" rx="8"/>
                <line x1="170" y1="160" x2="130" y2="200"/>
                <line x1="230" y1="160" x2="270" y2="200"/>
                <line x1="185" y1="280" x2="185" y2="350"/>
                <line x1="215" y1="280" x2="215" y2="350"/>
            </svg>`
        };

        // Screen Management
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showModeSelect() {
            showScreen('mode-screen');
        }

        function showPlayerSelect(mode) {
            gameState.mode = mode;
            if (mode === 'single') {
                gameState.playerCount = 1;
                showScreen('character-screen');
            } else {
                showScreen('player-screen');
            }
        }

        function setPlayers(count) {
            gameState.playerCount = count;
            showScreen('character-screen');
        }

        function selectCharacter(character) {
            gameState.selectedCharacter = character;
            
            // Update visual selection
            document.querySelectorAll('.character').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            document.getElementById('start-button').style.display = 'block';
        }

        function showTutorial() {
            showScreen('tutorial-screen');
        }

        function goBack() {
            if (gameState.mode === 'single') {
                showScreen('mode-screen');
            } else {
                showScreen('player-screen');
            }
        }

        // Game Logic
        function startGame() {
            showScreen('game-screen');
            initializeGame();
        }

        function initializeGame() {
            gameState.gameRunning = true;
            gameState.score = 0;
            gameState.timeLeft = 180;
            gameState.orders = [];
            gameState.heldItems = {};
            gameState.lastOrderTime = Date.now();

            // Set up player character
            const player = document.getElementById('player1');
            player.innerHTML = characters[gameState.selectedCharacter];

            // Start game timers
            startGameTimer();
            generateOrder();

            // Add event listeners
            document.addEventListener('keydown', handleKeyPress);
            setupClickHandlers();
        }

        function startGameTimer() {
            const timer = setInterval(() => {
                if (!gameState.gameRunning) {
                    clearInterval(timer);
                    return;
                }

                gameState.timeLeft--;
                updateTimerDisplay();

                // Generate new order every 30 seconds
                if (Date.now() - gameState.lastOrderTime > 30000) {
                    generateOrder();
                    gameState.lastOrderTime = Date.now();
                }

                // Update order timers
                updateOrderTimers();

                if (gameState.timeLeft <= 0) {
                    endGame();
                    clearInterval(timer);
                }
            }, 1000);
        }

        function generateOrder() {
            const soup = soups[Math.floor(Math.random() * soups.length)];
            const order = {
                id: Date.now(),
                soup: soup,
                timeLeft: 45,
                element: null
            };

            gameState.orders.push(order);
            addOrderToUI(order);
        }

        function addOrderToUI(order) {
            const ordersList = document.getElementById('orders-list');
            const orderElement = document.createElement('div');
            orderElement.className = 'order';
            orderElement.id = `order-${order.id}`;
            
            orderElement.innerHTML = `
                <span style="font-size: 1.5rem;">${order.soup.emoji}</span>
                <span>${order.soup.name}</span>
                <div class="order-timer">${order.timeLeft}s</div>
            `;
            
            order.element = orderElement;
            ordersList.appendChild(orderElement);
        }

        function updateOrderTimers() {
            gameState.orders.forEach((order, index) => {
                order.timeLeft--;
                if (order.element) {
                    const timerEl = order.element.querySelector('.order-timer');
                    timerEl.textContent = `${order.timeLeft}s`;
                    
                    if (order.timeLeft <= 10) {
                        timerEl.style.background = 'linear-gradient(145deg, #f44336, #c62828)';
                        timerEl.style.animation = 'pulse 0.5s infinite';
                    }
                }
                
                if (order.timeLeft <= 0) {
                    failOrder(order, index);
                }
            });
        }

        function failOrder(order, index) {
            gameState.score -= 70;
            updateScoreDisplay();
            showNotification('Order Failed! -70 XP', 'error');
            
            if (order.element) {
                order.element.remove();
            }
            gameState.orders.splice(index, 1);
        }

        function completeOrder(orderIndex) {
            const order = gameState.orders[orderIndex];
            gameState.score += 73;
            updateScoreDisplay();
            showNotification(`${order.soup.name} Complete! +73 XP`, 'success');
            
            if (order.element) {
                order.element.remove();
            }
            gameState.orders.splice(orderIndex, 1);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(gameState.timeLeft / 60);
            const seconds = gameState.timeLeft % 60;
            document.querySelector('.timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateScoreDisplay() {
            document.querySelector('.score').textContent = `XP: ${gameState.score}`;
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }

        // Player Movement and Interaction
        function handleKeyPress(event) {
            if (!gameState.gameRunning) return;
            
            const player = document.getElementById('player1');
            const currentTop = parseInt(player.style.top) || 400;
            const currentLeft = parseInt(player.style.left) || 200;
            const moveSpeed = 20;
            
            switch(event.key.toLowerCase()) {
                case 'w':
                    if (currentTop > 50) player.style.top = `${currentTop - moveSpeed}px`;
                    break;
                case 's':
                    if (currentTop < window.innerHeight - 100) player.style.top = `${currentTop + moveSpeed}px`;
                    break;
                case 'a':
                    if (currentLeft > 50) player.style.left = `${currentLeft - moveSpeed}px`;
                    break;
                case 'd':
                    if (currentLeft < window.innerWidth - 100) player.style.left = `${currentLeft + moveSpeed}px`;
                    break;
                case ' ':
                    event.preventDefault();
                    handlePlayerAction();
                    break;
            }
        }

        function setupClickHandlers() {
            // Ingredient click handlers
            document.querySelectorAll('.ingredient').forEach(ingredient => {
                ingredient.addEventListener('click', () => handleIngredientClick(ingredient));
            });

            // Counter click handlers
            document.querySelectorAll('.counter').forEach(counter => {
                counter.addEventListener('click', () => handleCounterClick(counter));
            });
        }

        function handleIngredientClick(ingredient) {
            const player = document.getElementById('player1');
            const ingredientType = ingredient.dataset.type;
            
            // Check if player is close enough
            if (!isPlayerNear(player, ingredient)) {
                showNotification('Move closer to pick up item!', 'error');
                return;
            }

            // Pick up ingredient
            if (!gameState.heldItems.player1) {
                gameState.heldItems.player1 = {
                    type: ingredientType,
                    state: 'raw'
                };
                updateHeldItemDisplay();
                showNotification(`Picked up ${ingredientType}!`);
            } else {
                showNotification('Hands are full!', 'error');
            }
        }

        function handleCounterClick(counter) {
            const player = document.getElementById('player1');
            
            if (!isPlayerNear(player, counter)) {
                showNotification('Move closer to the counter!', 'error');
                return;
            }

            const heldItem = gameState.heldItems.player1;
            
            if (!heldItem) {
                showNotification('Pick up an ingredient first!', 'error');
                return;
            }

            if (counter.classList.contains('counter-top')) {
                // Chopping counter
                if (heldItem.state === 'raw' && ['tomato', 'onion', 'mushroom'].includes(heldItem.type)) {
                    heldItem.state = 'chopped';
                    updateHeldItemDisplay();
                    showNotification(`${heldItem.type} chopped!`);
                } else {
                    showNotification('This item cannot be chopped!', 'error');
                }
            } else if (counter.classList.contains('stove')) {
                // Stove
                if (heldItem.type === 'pot') {
                    // Check if pot has chopped ingredients
                    if (heldItem.contents && heldItem.contents.state === 'chopped') {
                        heldItem.contents.state = 'cooked';
                        heldItem.state = 'ready';
                        updateHeldItemDisplay();
                        showNotification(`${heldItem.contents.type} soup cooked!`);
                    } else {
                        showNotification('Add chopped ingredients to pot first!', 'error');
                    }
                } else if (heldItem.state === 'chopped') {
                    showNotification('Put ingredients in a pot first!', 'error');
                }
            } else if (counter.classList.contains('sink')) {
                // Sink - washing dishes
                if (heldItem.type === 'bowl' && heldItem.state === 'dirty') {
                    heldItem.state = 'clean';
                    updateHeldItemDisplay();
                    showNotification('Bowl washed!');
                } else if (heldItem.type === 'pot' && heldItem.state === 'dirty') {
                    heldItem.state = 'clean';
                    heldItem.contents = null;
                    updateHeldItemDisplay();
                    showNotification('Pot washed!');
                }
            }
        }

        function handlePlayerAction() {
            const player = document.getElementById('player1');
            const heldItem = gameState.heldItems.player1;
            
            if (!heldItem) return;

            // Check for combining items (pot + chopped ingredient)
            if (heldItem.type === 'pot' && !heldItem.contents) {
                // Look for chopped ingredients nearby
                const ingredients = document.querySelectorAll('.ingredient');
                for (let ingredient of ingredients) {
                    if (isPlayerNear(player, ingredient)) {
                        const ingredientType = ingredient.dataset.type;
                        if (['tomato', 'onion', 'mushroom'].includes(ingredientType)) {
                            // Simulate adding chopped ingredient to pot
                            heldItem.contents = {
                                type: ingredientType,
                                state: 'chopped'
                            };
                            updateHeldItemDisplay();
                            showNotification(`Added ${ingredientType} to pot!`);
                            return;
                        }
                    }
                }
            }

            // Check for serving (cooked soup + bowl)
            if (heldItem.type === 'pot' && heldItem.state === 'ready') {
                // Look for clean bowl nearby
                const bowls = document.querySelectorAll('[data-type="bowl"]');
                for (let bowl of bowls) {
                    if (isPlayerNear(player, bowl)) {
                        serveSoup(heldItem.contents.type);
                        heldItem.state = 'dirty';
                        heldItem.contents = null;
                        updateHeldItemDisplay();
                        return;
                    }
                }
                showNotification('Need a clean bowl to serve!', 'error');
            }
        }

        function serveSoup(soupType) {
            // Find matching order
            const orderIndex = gameState.orders.findIndex(order => 
                order.soup.ingredient === soupType
            );
            
            if (orderIndex !== -1) {
                completeOrder(orderIndex);
            } else {
                showNotification('No order for this soup!', 'error');
            }
        }

        function isPlayerNear(player, target) {
            const playerRect = player.getBoundingClientRect();
            const targetRect = target.getBoundingClientRect();
            
            const distance = Math.sqrt(
                Math.pow(playerRect.left - targetRect.left, 2) + 
                Math.pow(playerRect.top - targetRect.top, 2)
            );
            
            return distance < 100;
        }

        function updateHeldItemDisplay() {
            const player = document.getElementById('player1');
            const heldItem = gameState.heldItems.player1;
            
            // Remove existing held item display
            const existingHeldItem = player.querySelector('.held-item');
            if (existingHeldItem) {
                existingHeldItem.remove();
            }
            
            if (heldItem) {
                const heldItemElement = document.createElement('div');
                heldItemElement.className = 'held-item';
                
                let emoji = '';
                switch(heldItem.type) {
                    case 'tomato': emoji = heldItem.state === 'chopped' ? '🥗' : '🍅'; break;
                    case 'onion': emoji = heldItem.state === 'chopped' ? '🥗' : '🧅'; break;
                    case 'mushroom': emoji = heldItem.state === 'chopped' ? '🥗' : '🍄'; break;
                    case 'pot': 
                        if (heldItem.state === 'ready') emoji = '🍲';
                        else if (heldItem.contents) emoji = '🥘';
                        else emoji = '🍲';
                        break;
                    case 'bowl': emoji = '🥣'; break;
                }
                
                heldItemElement.textContent = emoji;
                player.appendChild(heldItemElement);
            }
        }

        function endGame() {
            gameState.gameRunning = false;
            document.getElementById('final-score').textContent = `Final Score: ${gameState.score} XP`;
            document.getElementById('game-over').style.display = 'block';
        }

        function restartGame() {
            document.getElementById('game-over').style.display = 'none';
            document.getElementById('orders-list').innerHTML = '';
            initializeGame();
        }

        // Add pulse animation for urgent timers
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);

        // Initialize game on page load
        window.addEventListener('load', () => {
            showScreen('welcome-screen');
        });

        // Make functions globally accessible
        window.showModeSelect = showModeSelect;
        window.showPlayerSelect = showPlayerSelect;
        window.setPlayers = setPlayers;
        window.selectCharacter = selectCharacter;
        window.showTutorial = showTutorial;
        window.goBack = goBack;
        window.startGame = startGame;
        window.restartGame = restartGame;
        window.showScreen = showScreen;
